version: 2

models:
  # =============================================================================
  # BAN ADDRESSES NORMALIZED - Pr√©paration pour matching
  # =============================================================================
  - name: ban_addresses_normalized
    description: |
      **BAN Addresses Normalized - Couche Silver optimis√©e pour le g√©ocodage**

      Pr√©paration des adresses BAN (Base Adresse Nationale) avec cr√©ation de cl√©s
      de matching multiples pour faciliter la jointure avec les adresses DVF.

      **üéØ Objectif :**
      Optimiser les performances et la qualit√© du matching adresse DVF ‚Üî BAN
      en pr√©-calculant des cl√©s de jointure √† diff√©rents niveaux de pr√©cision.

      **üîß Transformations appliqu√©es :**
      1. Normalisation stricte (UPPER, TRIM, REGEXP_REPLACE espaces multiples)
      2. Cr√©ation de 5 cl√©s de matching :
         - MATCH_KEY_EXACT : num√©ro + r√©p√©tition + nom voie complet + CP + commune
         - MATCH_KEY_SANS_TYPE : num√©ro + voie (sans type) + CP + commune
         - MATCH_KEY_VOIE : nom voie + CP + commune (sans num√©ro)
         - MATCH_KEY_CODE_POSTAL : code postal + commune
         - MATCH_KEY_COMMUNE : code INSEE seul
      3. Extraction du nom de voie sans type (suppression RUE, AVENUE, etc.)
      4. Calcul de scores de qualit√© (pr√©cision + certification)
      5. Filtrage coordonn√©es GPS valides (France m√©tropolitaine)

      **üìä Colonnes cl√©s g√©n√©r√©es :**
      - NUMERO_COMPLET : num√©ro + r√©p√©tition (ex: "12 BIS")
      - NOM_VOIE_SANS_TYPE : voie √©pur√©e pour matching flexible
      - MATCH_KEY_* : cl√©s de jointure pr√©-calcul√©es
      - QUALITY_SCORE : score combin√© (pr√©cision + certification)
      - PRECISION_SCORE : score bas√© sur TYPE_POSITION

      **üéØ Utilisation :**
      Source pour dim_address_enriched (matching multi-niveaux).
      Mat√©rialis√© en VIEW pour fra√Æcheur des donn√©es BAN.

      **Grain :** Une ligne par adresse BAN avec coordonn√©es GPS valides

    columns:
      - name: BAN_ID
        description: Identifiant unique BAN
        tests:
          - unique
          - not_null

      - name: MATCH_KEY_EXACT
        description: |
          Cl√© de matching niveau 1 (la plus pr√©cise).
          Format : numero|repetition|nom_voie_complet|code_postal|commune
        tests:
          - not_null

      - name: MATCH_KEY_SANS_TYPE
        description: |
          Cl√© de matching niveau 2 (sans type de voie).
          G√®re les variations "Rue Victor Hugo" vs "Victor Hugo"
        tests:
          - not_null

      - name: MATCH_KEY_VOIE
        description: |
          Cl√© de matching niveau 3 (voie seule, sans num√©ro).
          Utilis√©e pour centro√Øde de rue
        tests:
          - not_null

      - name: MATCH_KEY_CODE_POSTAL
        description: |
          Cl√© de matching niveau 4 (code postal + commune).
          Fallback pour adresses incompl√®tes
        tests:
          - not_null

      - name: MATCH_KEY_COMMUNE
        description: |
          Cl√© de matching niveau 5 (code INSEE seul).
          Dernier recours avant NO_MATCH
        tests:
          - not_null

      - name: LONGITUDE
        description: |
          Longitude GPS (WGS84).
          Filtr√©e pour France m√©tropolitaine : -5.5 √† 10.0
        tests:
          - not_null

      - name: LATITUDE
        description: |
          Latitude GPS (WGS84).
          Filtr√©e pour France m√©tropolitaine : 41.0 √† 51.5
        tests:
          - not_null

      - name: QUALITY_SCORE
        description: |
          Score de qualit√© combin√© (10-110).
          = PRECISION_SCORE + CERTIFICATION_SCORE (0 ou 10)
        tests:
          - not_null

      - name: TYPE_POSITION
        description: |
          Type de positionnement BAN.
          Valeurs : HOUSENUMBER, INTERPOLATION, STREET, LOCALITY, MUNICIPALITY
        tests:
          - not_null

sources:
  - name: bronze
    database: VALFONC_RAW
    schema: BRONZE
    description: |
      **Couche Bronze - Donn√©es brutes**
      
      Donn√©es sources non transform√©es, charg√©es depuis les fichiers sources.
    
    tables:
      - name: DVF_RAW_VARCHAR
        description: |
          Donn√©es brutes DVF (Demandes de Valeurs Fonci√®res) avec toutes les colonnes en VARCHAR.
          Source originale avant toute transformation.
        
      - name: BAN_ADRESSES
        description: |
          **Base Adresse Nationale (BAN) - Donn√©es brutes**
          
          R√©f√©rentiel national des adresses fran√ßaises.
          Contient les coordonn√©es g√©ographiques (GPS + Lambert 93), les codes INSEE,
          et les informations cadastrales pour chaque adresse en France.
          
          Source : data.gouv.fr - Base Adresse Nationale
          Format : CSV consolid√© national
          
          **Utilisation :**
          - G√©ocodage des adresses DVF
          - Enrichissement des coordonn√©es GPS
          - Validation des codes postaux et communes
          - Matching avec les parcelles cadastrales
        
        columns:
          - name: id
            description: Identifiant unique BAN de l'adresse
          
          - name: id_fantoir
            description: Identifiant FANTOIR de la voie (code national)
          
          - name: numero
            description: Num√©ro de voie
          
          - name: rep
            description: Indice de r√©p√©tition (bis, ter, quater, etc.)
          
          - name: nom_voie
            description: Nom complet de la voie
          
          - name: code_postal
            description: Code postal (5 chiffres)
          
          - name: code_insee
            description: Code INSEE de la commune (5 chiffres)
          
          - name: nom_commune
            description: Nom officiel de la commune
          
          - name: code_insee_ancienne_commune
            description: Code INSEE de l'ancienne commune (avant fusion)
          
          - name: nom_ancienne_commune
            description: Nom de l'ancienne commune (avant fusion)
          
          - name: x
            description: Coordonn√©e X en projection Lambert 93 (m√®tres)
          
          - name: y
            description: Coordonn√©e Y en projection Lambert 93 (m√®tres)
          
          - name: lon
            description: Longitude en WGS84 (degr√©s d√©cimaux)
          
          - name: lat
            description: Latitude en WGS84 (degr√©s d√©cimaux)
          
          - name: type_position
            description: |
              Pr√©cision du positionnement g√©ographique.
              Valeurs : housenumber, street, locality, municipality
          
          - name: alias
            description: Indicateur si l'adresse est un alias (0 ou 1)
          
          - name: nom_ld
            description: Nom du lieu-dit (si applicable)
          
          - name: libelle_acheminement
            description: Libell√© d'acheminement postal
          
          - name: nom_afnor
            description: Nom de voie normalis√© AFNOR
          
          - name: source_position
            description: Source des coordonn√©es g√©ographiques
          
          - name: source_nom_voie
            description: Source du nom de voie
          
          - name: certification_commune
            description: Niveau de certification par la commune (0 ou 1)
          
          - name: cad_parcelles
            description: Liste des parcelles cadastrales associ√©es
          
          - name: departement
            description: Code d√©partement (2 ou 3 chiffres)
