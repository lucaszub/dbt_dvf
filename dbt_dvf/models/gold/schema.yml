version: 2

models:
  # =============================================================================
  # DIMENSION : ADRESSES
  # =============================================================================
  - name: dim_address
    description: |
      **Dimension Adresse - R√©f√©rentiel des adresses normalis√©es**

      Table de dimension contenant toutes les adresses uniques issues des transactions DVF.

      **Processus de construction :**
      1. Normalisation des composants d'adresse (trim, upper, suppression espaces multiples)
      2. G√©n√©ration d'une cl√© technique (HASH) bas√©e sur les 6 composants
      3. D√©duplication stricte via QUALIFY ROW_NUMBER()

      **Utilisation :**
      - Jointure avec fact_mutation sur ADDRESS_ID
      - Permet analyses g√©ographiques et reporting par adresse
      - Format de cl√© HEX (64 bits) compatible Power BI (pas de probl√®me de pr√©cision)

      **Grain :** Une ligne par adresse unique (NO_VOIE + TYPE_DE_VOIE + VOIE + CODE_POSTAL + COMMUNE + CODE_DEPARTEMENT)

    columns:
      - name: ADDRESS_ID
        description: |
          **Cl√© primaire technique** - Identifiant unique de l'adresse.

          G√©n√©r√©e via HASH des 6 composants normalis√©s, convertie en HEX (format texte XXXXXXXXXXXXXXXX).
          Ce format √©vite tout probl√®me de pr√©cision num√©rique dans Power BI.

          Formule : HASH(NO_VOIE || TYPE_DE_VOIE || VOIE || CODE_POSTAL || COMMUNE || CODE_DEPARTEMENT)
        tests:
          - unique
          - not_null

      - name: NO_VOIE
        description: |
          Num√©ro de voie normalis√© (UPPER + TRIM).
          Exemple : "123", "45 BIS"

      - name: TYPE_DE_VOIE
        description: |
          Type de voie normalis√© (UPPER + TRIM).
          Exemple : RUE, AVENUE, BOULEVARD, CHEMIN, IMPASSE, PLACE

      - name: VOIE
        description: |
          Nom de la voie normalis√© (UPPER + TRIM + espaces multiples √©cras√©s).
          Exemple : "VICTOR HUGO", "DE LA REPUBLIQUE"

      - name: CODE_POSTAL
        description: |
          Code postal normalis√© (TRIM).
          Format : 5 chiffres pour m√©tropole, codes sp√©ciaux pour DOM-TOM.
        tests:
          - not_null

      - name: COMMUNE
        description: |
          Nom de la commune normalis√© (UPPER + TRIM + espaces multiples √©cras√©s).
          Exemple : "PARIS", "MARSEILLE", "SAINT ETIENNE"
        tests:
          - not_null

      - name: CODE_DEPARTEMENT
        description: |
          Code d√©partement normalis√© (TRIM).
          Format : 2 chiffres (m√©tropole) ou 3 chiffres (DOM-TOM).
          Exemple : "75", "13", "971"
        tests:
          - not_null

      - name: ADDRESS
        description: |
          Libell√© complet de l'adresse, lisible par un humain.
          Concat√©nation : NO_VOIE + TYPE_DE_VOIE + VOIE + CODE_POSTAL + COMMUNE

          Exemple : "123 RUE VICTOR HUGO 75001 PARIS"

      - name: CREATED_AT
        description: |
          Horodatage de cr√©ation de l'enregistrement dans la dimension.
          Aliment√© via CURRENT_TIMESTAMP() lors de l'ex√©cution dbt.
        tests:
          - not_null

  # =============================================================================
  # DIMENSION : ADRESSES ENRICHIES BAN
  # =============================================================================
  - name: dim_address_enriched
    description: |
      **Dimension Adresse Enrichie - G√©ocodage BAN (Base Adresse Nationale)**

      Table de dimension contenant toutes les adresses uniques issues des transactions DVF,
      enrichies avec les coordonn√©es GPS et les m√©tadonn√©es de la Base Adresse Nationale.

      **üéØ Objectif :** Permettre des analyses g√©ospatiales pr√©cises en associant chaque adresse DVF
      √† ses coordonn√©es g√©ographiques exactes via un matching multi-niveaux avec la BAN.

      **üîÑ Strat√©gie de matching (du plus pr√©cis au moins pr√©cis) :**

      | Niveau | Crit√®res | Score | Pr√©cision GPS |
      |--------|----------|-------|---------------|
      | EXACT | Num√©ro + nom voie complet + CP + commune | 100 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê < 10m |
      | SANS_TYPE | Num√©ro + voie (sans type) + CP + commune | 90 | ‚≠ê‚≠ê‚≠ê‚≠ê ~10-20m |
      | VOIE_SEULE | Nom voie + CP + commune (centro√Øde rue) | 70 | ‚≠ê‚≠ê‚≠ê ~50-200m |
      | CODE_POSTAL | Code postal + commune (centro√Øde CP) | 50 | ‚≠ê‚≠ê ~200-500m |
      | COMMUNE | Code INSEE seul (centro√Øde commune) | 30 | ‚≠ê > 500m |
      | NO_MATCH | Aucun enrichissement trouv√© | 0 | ‚ùå Pas de coordonn√©es |

      **üìä Processus de construction :**
      1. Extraction des adresses uniques depuis DVF (normalisation stricte)
      2. Cr√©ation de cl√©s de matching multiples (exact, sans type, voie seule, etc.)
      3. Jointures successives avec ban_addresses_normalized √† diff√©rents niveaux
      4. S√©lection du meilleur match (score de qualit√© + pr√©cision)
      5. Calcul des m√©tadonn√©es de qualit√© (MATCH_LEVEL, MATCH_SCORE)

      **‚ú® Enrichissements disponibles :**
      - üó∫Ô∏è Coordonn√©es GPS (WGS84) : LONGITUDE, LATITUDE
      - üìç Coordonn√©es Lambert 93 : X_LAMBERT93, Y_LAMBERT93 (pour calculs de distance)
      - üèõÔ∏è Code INSEE commune + ID FANTOIR voie
      - üì¶ Parcelles cadastrales associ√©es (depuis BAN)
      - ‚úÖ M√©tadonn√©es qualit√© : niveau de matching, score de confiance

      **üéØ Utilisation :**
      - Cartographie des transactions (Power BI Maps, Tableau, QGIS)
      - Calculs de distance entre biens
      - Analyses de proximit√© (transports, √©coles, commerces)
      - Clustering g√©ographique et hotspots
      - Filtrage par qualit√© de g√©ocodage

      **Grain :** Une ligne par adresse unique DVF avec enrichissement BAN optimal

    columns:
      # -------------------------------------------------------------------------
      # IDENTIFIANTS
      # -------------------------------------------------------------------------
      - name: ADDRESS_ID
        description: |
          **Cl√© primaire technique** - Identifiant unique de l'adresse.

          G√©n√©r√©e via HASH des 6 composants DVF normalis√©s (NO_VOIE + TYPE_DE_VOIE + VOIE + CODE_POSTAL + COMMUNE + CODE_DEPARTEMENT).
          Format HEX (XXXXXXXXXXXXXXXX) compatible Power BI.

          Cette cl√© est stable et identique √† celle de l'ancienne dim_address pour compatibilit√© ascendante.
        tests:
          - unique
          - not_null

      - name: BAN_ID
        description: |
          **Identifiant BAN** - ID unique de l'adresse dans la Base Adresse Nationale.

          NULL si aucun match BAN trouv√© (MATCH_LEVEL = 'NO_MATCH' ou matching par centro√Øde).

          Pr√©sent uniquement pour les niveaux EXACT et SANS_TYPE (matching pr√©cis sur adresse compl√®te).

          **Utilisation :** Lien vers le r√©f√©rentiel BAN pour enrichissements futurs.

      # -------------------------------------------------------------------------
      # ADRESSE DVF (normalis√©e)
      # -------------------------------------------------------------------------
      - name: NO_VOIE
        description: |
          Num√©ro de voie normalis√© (UPPER + TRIM).
          Exemple : "123", "45"

      - name: TYPE_DE_VOIE
        description: |
          Type de voie normalis√© (UPPER + TRIM).
          Exemples : RUE, AVENUE, BOULEVARD, CHEMIN, IMPASSE, PLACE

      - name: VOIE
        description: |
          Nom de la voie normalis√© (UPPER + TRIM + espaces multiples √©cras√©s).
          Exemples : "VICTOR HUGO", "DE LA REPUBLIQUE"

      - name: CODE_POSTAL
        description: |
          Code postal normalis√© (TRIM).
          Format : 5 chiffres pour m√©tropole.
        tests:
          - not_null

      - name: COMMUNE
        description: |
          Nom de la commune normalis√© (UPPER + TRIM).
          Exemples : "PARIS", "MARSEILLE", "LYON"
        tests:
          - not_null

      - name: CODE_DEPARTEMENT
        description: |
          Code d√©partement normalis√© (TRIM).
          Format : 2 ou 3 chiffres.
        tests:
          - not_null

      - name: ADDRESS_FULL
        description: |
          **Adresse compl√®te format√©e** pour affichage.

          Concat√©nation : NO_VOIE + TYPE_DE_VOIE + VOIE + CODE_POSTAL + COMMUNE

          Exemple : "123 RUE VICTOR HUGO, 75001 PARIS"

      # -------------------------------------------------------------------------
      # ENRICHISSEMENT BAN
      # -------------------------------------------------------------------------
      - name: CODE_INSEE
        description: |
          **Code INSEE de la commune** (5 chiffres).

          Issu du r√©f√©rentiel BAN, plus fiable que le nom de commune pour les analyses administratives.

          Exemples : "75101" (Paris 1er), "13055" (Marseille)

          NULL si aucun match BAN trouv√©.

      - name: ID_FANTOIR
        description: |
          **Identifiant FANTOIR de la voie** - Code national unique de la voie.

          Format : CODE_INSEE (5) + CODE_VOIE (4) = 9 caract√®res

          Le FANTOIR (Fichier Annuaire Topographique Initialis√© R√©duit) est le r√©f√©rentiel
          national des voies g√©r√© par la DGFiP.

          NULL si matching par centro√Øde (pas de voie pr√©cise identifi√©e).

      # -------------------------------------------------------------------------
      # COORDONN√âES G√âOGRAPHIQUES
      # -------------------------------------------------------------------------
      - name: LONGITUDE
        description: |
          **Longitude GPS** en degr√©s d√©cimaux (syst√®me WGS84).

          Plage France m√©tropolitaine : -5.5 √† 10.0

          NULL si MATCH_LEVEL = 'NO_MATCH'.

          **Utilisation :**
          - Cartographie web (Google Maps, Leaflet, Mapbox)
          - Power BI Maps, Tableau
          - Analyses g√©ospatiales

          **Pr√©cision :** D√©pend du MATCH_LEVEL (voir TYPE_POSITION)

      - name: LATITUDE
        description: |
          **Latitude GPS** en degr√©s d√©cimaux (syst√®me WGS84).

          Plage France m√©tropolitaine : 41.0 √† 51.5

          NULL si MATCH_LEVEL = 'NO_MATCH'.

          **Utilisation :**
          - Cartographie web
          - Calculs de distance (formule haversine)
          - G√©olocalisation

          **Pr√©cision :** D√©pend du MATCH_LEVEL (voir TYPE_POSITION)

      - name: X_LAMBERT93
        description: |
          **Coordonn√©e X en projection Lambert 93** (m√®tres).

          Le Lambert 93 (EPSG:2154) est la projection officielle fran√ßaise, recommand√©e pour :
          - Calculs de distance pr√©cis sur le territoire fran√ßais
          - SIG (Syst√®mes d'Information G√©ographique)
          - Calculs d'aire et de p√©rim√®tre

          NULL si pas de coordonn√©es GPS disponibles.

          **Avantage vs GPS :** Unit√©s m√©triques directes, pas de distorsion sph√©rique.

      - name: Y_LAMBERT93
        description: |
          **Coordonn√©e Y en projection Lambert 93** (m√®tres).

          Compl√©ment de X_LAMBERT93 pour positionnement 2D en projection plane.

          NULL si pas de coordonn√©es GPS disponibles.

      # -------------------------------------------------------------------------
      # QUALIT√â DU G√âOCODAGE
      # -------------------------------------------------------------------------
      - name: MATCH_LEVEL
        description: |
          **Niveau de matching adresse ‚Üî BAN** (qualit√© du g√©ocodage).

          Valeurs possibles (ordre d√©croissant de pr√©cision) :

          - **EXACT** (score 100)
            ‚Üí Match parfait sur num√©ro + nom voie complet + CP + commune
            ‚Üí Pr√©cision GPS : < 10m (adresse exacte)
            ‚Üí Recommand√© pour analyses g√©ospatiales fines

          - **SANS_TYPE** (score 90)
            ‚Üí Match sur num√©ro + voie (sans type "rue/avenue") + CP + commune
            ‚Üí Pr√©cision GPS : ~10-20m
            ‚Üí Tr√®s bonne qualit√©

          - **VOIE_SEULE** (score 70)
            ‚Üí Match sur nom de voie + CP + commune (sans num√©ro)
            ‚Üí Coordonn√©es = centro√Øde de la rue
            ‚Üí Pr√©cision GPS : ~50-200m
            ‚Üí Acceptable pour analyses par quartier

          - **CODE_POSTAL** (score 50)
            ‚Üí Centro√Øde du code postal
            ‚Üí Pr√©cision GPS : ~200-500m
            ‚Üí Qualit√© moyenne, utiliser avec pr√©caution

          - **COMMUNE** (score 30)
            ‚Üí Centro√Øde de la commune (centre g√©om√©trique)
            ‚Üí Pr√©cision GPS : > 500m
            ‚Üí Faible pr√©cision, √©viter pour analyses g√©ospatiales

          - **NO_MATCH** (score 0)
            ‚Üí Aucun match BAN trouv√©
            ‚Üí Pas de coordonn√©es GPS
            ‚Üí N√©cessite investigation

          **Utilisation :**
          Filtrer sur MATCH_LEVEL IN ('EXACT', 'SANS_TYPE') pour analyses g√©ospatiales pr√©cises.
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['EXACT', 'SANS_TYPE', 'VOIE_SEULE', 'CODE_POSTAL', 'COMMUNE', 'NO_MATCH']

      - name: MATCH_SCORE
        description: |
          **Score de qualit√© du matching** (0-100).

          Corr√©l√© au MATCH_LEVEL :
          - 100 = EXACT
          - 90 = SANS_TYPE
          - 70 = VOIE_SEULE
          - 50 = CODE_POSTAL
          - 30 = COMMUNE
          - 0 = NO_MATCH

          **Utilisation :**
          - Filtrer les analyses : WHERE MATCH_SCORE >= 70
          - Pond√©ration par qualit√© dans les agr√©gations
          - KPI de qualit√© du r√©f√©rentiel
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [0, 30, 50, 70, 90, 100]

      - name: TYPE_POSITION
        description: |
          **Type de positionnement GPS** (m√©tadonn√©e BAN).

          Valeurs possibles :

          - **HOUSENUMBER** : Num√©ro exact dans la voie (pr√©cision < 10m)
          - **INTERPOLATION** : Num√©ro interpol√© entre deux points connus (~10-50m)
          - **STREET** : Centro√Øde de la rue (~50-200m)
          - **LOCALITY** : Lieu-dit ou hameau (~200-500m)
          - **MUNICIPALITY** : Centro√Øde de la commune (> 500m)
          - **NULL** : Pas de coordonn√©es (NO_MATCH)

          **Utilisation :**
          Indicateur de fiabilit√© du positionnement pour filtrage analyses g√©ospatiales.

      - name: SOURCE_POSITION
        description: |
          **Source des coordonn√©es g√©ographiques**.

          Valeurs courantes :
          - 'IGN' : Institut National de l'Information G√©ographique et Foresti√®re
          - 'CADASTRE' : Direction G√©n√©rale des Finances Publiques
          - 'OSM' : OpenStreetMap (contribution communautaire)
          - 'SDIS' : Service D√©partemental d'Incendie et de Secours
          - 'COMMUNE' : Certification par la commune
          - 'COMPUTED_CENTROID' : Centro√Øde calcul√© (CODE_POSTAL ou COMMUNE niveau)

          NULL si pas de coordonn√©es.

      - name: BAN_QUALITY_SCORE
        description: |
          **Score de qualit√© interne BAN** (calcul√© depuis precision + certification).

          Combine :
          - Pr√©cision du positionnement (TYPE_POSITION)
          - Certification par la commune (0-10 points bonus)

          Plage : 10-110

          NULL si pas de match BAN.

          **Utilisation :** D√©partager plusieurs matchs BAN pour une m√™me adresse DVF.

      # -------------------------------------------------------------------------
      # ENRICHISSEMENT CADASTRAL
      # -------------------------------------------------------------------------
      - name: PARCELLES_CADASTRALES
        description: |
          **Liste des parcelles cadastrales** associ√©es √† l'adresse (depuis BAN).

          Format : codes parcelles s√©par√©s par virgules ou pipes
          Exemple : "AB0123|AB0124"

          NULL si pas de match BAN ou pas de donn√©es cadastrales disponibles.

          **Utilisation :**
          - Croisement avec dim_parcelle DVF
          - Validation coh√©rence adresse ‚Üî parcelle

      - name: LIBELLE_ACHEMINEMENT
        description: |
          **Libell√© d'acheminement postal** (nom officiel La Poste).

          Peut diff√©rer du nom de commune (arrondissements parisiens, communes d√©l√©gu√©es).

          Exemples : "PARIS 01", "LYON 03", "MARSEILLE 08"

          NULL si pas de match BAN.

      - name: NOM_AFNOR
        description: |
          **Nom de voie normalis√© AFNOR** (norme fran√ßaise Z 10-011).

          Normalisation stricte pour tri alphab√©tique et indexation.

          NULL si matching par centro√Øde (pas de voie pr√©cise).

      # -------------------------------------------------------------------------
      # AUDIT
      # -------------------------------------------------------------------------
      - name: CREATED_AT
        description: |
          Horodatage de cr√©ation de l'enregistrement.
          Aliment√© via CURRENT_TIMESTAMP() lors du run dbt.
        tests:
          - not_null

      - name: UPDATED_AT
        description: |
          Horodatage de derni√®re mise √† jour.
          Identique √† CREATED_AT pour ce mod√®le (pas de mises √† jour incr√©mentales).
        tests:
          - not_null

  # =============================================================================
  # DIMENSION : CODES POSTAUX
  # =============================================================================
  - name: dim_code_postal
    description: |
      **Dimension Code Postal - R√©f√©rentiel g√©ographique**

      Table de dimension contenant les codes postaux uniques avec leurs attributs g√©ographiques.

      **Processus de construction :**
      1. Normalisation (trim, upper, suppression espaces multiples)
      2. Cl√© technique bas√©e sur CP + d√©partement
      3. D√©duplication : un code postal peut couvrir plusieurs communes, on garde la premi√®re par ordre alphab√©tique

      **Utilisation :**
      - Jointure avec fact_mutation sur CODE_POSTAL_ID
      - Enrichissement cartographique possible (LATITUDE/LONGITUDE en placeholder)
      - Agr√©gation g√©ographique niveau code postal

      **Grain :** Une ligne par couple unique (CODE_POSTAL, CODE_DEPARTEMENT)

    columns:
      - name: CODE_POSTAL_ID
        description: |
          **Cl√© primaire technique** - Identifiant unique du code postal.

          G√©n√©r√©e via HASH(CODE_POSTAL || CODE_DEPARTEMENT), format HEX.
          Garantit l'unicit√© m√™me si un code postal existe dans plusieurs d√©partements.
        tests:
          - unique
          - not_null

      - name: CODE_POSTAL
        description: |
          Code postal normalis√© (TRIM).
          5 chiffres en g√©n√©ral.
        tests:
          - not_null

      - name: COMMUNE
        description: |
          Nom de la commune principale associ√©e √† ce code postal (normalis√©).
          En cas de multi-communes, la premi√®re par ordre alphab√©tique est retenue.

      - name: CODE_DEPARTEMENT
        description: |
          Code d√©partement normalis√© (TRIM).
          Lien avec la dimension commune et adresse.
        tests:
          - not_null

      - name: VOIE
        description: |
          Nom d'une voie repr√©sentative pour ce code postal (normalis√©).
          Information contextuelle, peut varier selon les donn√©es sources.

      - name: CREATED_AT
        description: |
          Horodatage de cr√©ation de l'enregistrement.
          Aliment√© via CURRENT_TIMESTAMP().
        tests:
          - not_null

  # =============================================================================
  # DIMENSION : COMMUNES
  # =============================================================================
  - name: dim_commune
    description: |
      **Dimension Commune - R√©f√©rentiel administratif**

      Table de dimension contenant toutes les communes uniques issues des adresses.

      **Processus de construction :**
      1. Source : dim_address (adresses d√©j√† normalis√©es)
      2. Extraction COMMUNE + CODE_DEPARTEMENT
      3. G√©n√©ration cl√© technique via HASH
      4. D√©duplication stricte

      **Utilisation :**
      - Jointure avec fact_mutation sur COMMUNE_ID
      - Analyses g√©ographiques niveau commune
      - Reporting par collectivit√© territoriale

      **Grain :** Une ligne par couple unique (COMMUNE, CODE_DEPARTEMENT)

    columns:
      - name: COMMUNE_ID
        description: |
          **Cl√© primaire technique** - Identifiant unique de la commune.

          G√©n√©r√©e via HASH(COMMUNE || CODE_DEPARTEMENT).
          Le d√©partement est n√©cessaire car certaines communes ont le m√™me nom dans diff√©rents d√©partements.
          Exemple : "Saint-Denis" existe en Seine-Saint-Denis (93) et √† La R√©union (974).
        tests:
          - unique
          - not_null

      - name: COMMUNE
        description: |
          Nom de la commune normalis√© (UPPER + TRIM).
          Exemple : "PARIS", "LYON", "MARSEILLE"
        tests:
          - not_null

      - name: CODE_DEPARTEMENT
        description: |
          Code d√©partement normalis√© (TRIM).
          Permet de distinguer les homonymes.
        tests:
          - not_null

      - name: CREATED_AT
        description: |
          Horodatage de cr√©ation de l'enregistrement.
          Aliment√© via CURRENT_TIMESTAMP().
        tests:
          - not_null

  # =============================================================================
  # DIMENSION : PARCELLES CADASTRALES
  # =============================================================================
  - name: dim_parcelle
    description: |
      **Dimension Parcelle - R√©f√©rentiel cadastral**

      Table de dimension contenant les parcelles cadastrales uniques.

      **Identification cadastrale :**
      Une parcelle est identifi√©e par :
      - PREFIXE_DE_SECTION (optionnel)
      - SECTION (obligatoire)
      - NO_PLAN (obligatoire)
      - NO_VOLUME (optionnel, pour copropri√©t√©s)

      **Processus de construction :**
      1. Normalisation (trim, upper)
      2. G√©n√©ration cl√© technique via HASH des 4 composants
      3. Flag qualit√© IS_PARTIAL si SECTION ou NO_PLAN manquants
      4. D√©duplication stricte

      **Utilisation :**
      - Jointure avec fact_mutation sur PARCELLE_ID
      - Analyses fonci√®res et cadastrales
      - Suivi des mutations par parcelle

      **Grain :** Une ligne par combinaison unique (PREFIXE_DE_SECTION, SECTION, NO_PLAN, NO_VOLUME)

    columns:
      - name: PARCELLE_ID
        description: |
          **Cl√© primaire technique** - Identifiant unique de la parcelle cadastrale.

          G√©n√©r√©e via HASH des 4 composants cadastraux normalis√©s.
          Permet de suivre les mutations multiples sur une m√™me parcelle.
        tests:
          - unique
          - not_null

      - name: PREFIXE_DE_SECTION
        description: |
          Pr√©fixe de la section cadastrale (normalis√© UPPER + TRIM).
          Optionnel, peut √™tre NULL.
          Utilis√© pour subdiviser g√©ographiquement les sections.

      - name: SECTION
        description: |
          Section cadastrale (normalis√©e UPPER + TRIM).
          Obligatoire pour identifier une parcelle.
          Format : g√©n√©ralement 2 caract√®res (ex : "AB", "01").

      - name: NO_PLAN
        description: |
          Num√©ro de plan cadastral (normalis√© TRIM).
          Obligatoire, identifie la parcelle au sein de la section.
          Format : num√©rique (ex : "123", "0045").

      - name: NO_VOLUME
        description: |
          Num√©ro de volume (normalis√© TRIM).
          Optionnel, utilis√© pour les lots en copropri√©t√©.
          NULL si parcelle simple (non divis√©e en volumes).

      - name: IS_PARTIAL
        description: |
          **Flag qualit√©** - Indicateur de parcelle incompl√®te.

          Valeurs :
          - 0 : Parcelle compl√®te (SECTION et NO_PLAN renseign√©s)
          - 1 : Parcelle incompl√®te (SECTION ou NO_PLAN manquants)

          Permet de filtrer les parcelles mal identifi√©es pour des analyses de qualit√©.
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [0, 1]

      - name: CREATED_AT
        description: |
          Horodatage de cr√©ation de l'enregistrement.
          Aliment√© via CURRENT_TIMESTAMP().
        tests:
          - not_null

  # =============================================================================
  # DIMENSION : TYPES DE LOCAUX
  # =============================================================================
  - name: dim_type_local
    description: |
      **Dimension Type de Local - R√©f√©rentiel typologique**

      Table de dimension contenant les types de biens immobiliers.

      **Valeurs courantes :**
      - Maison
      - Appartement
      - Local industriel. commercial. ou assimil√©
      - D√©pendance
      - INCONNU (valeur par d√©faut si NULL)

      **Processus de construction :**
      1. Normalisation (UPPER + TRIM)
      2. Remplacement NULL ‚Üí 'INCONNU'
      3. G√©n√©ration cl√© technique via HASH
      4. D√©duplication stricte

      **Utilisation :**
      - Jointure avec fact_mutation sur TYPE_LOCAL_ID
      - Segmentation des analyses par type de bien
      - Reporting march√© r√©sidentiel vs commercial

      **Grain :** Une ligne par type de local unique

    columns:
      - name: TYPE_LOCAL_ID
        description: |
          **Cl√© primaire technique** - Identifiant unique du type de local.

          G√©n√©r√©e via HASH(TYPE_LOCAL).
          La valeur 'INCONNU' est utilis√©e comme fallback pour les types NULL.
        tests:
          - unique
          - not_null

      - name: TYPE_LOCAL
        description: |
          Libell√© du type de local normalis√© (UPPER + TRIM).

          Valeurs principales :
          - MAISON
          - APPARTEMENT
          - LOCAL INDUSTRIEL. COMMERCIAL. OU ASSIMIL√â
          - D√âPENDANCE
          - INCONNU (si valeur source NULL)
        tests:
          - not_null

      - name: CREATED_AT
        description: |
          Horodatage de cr√©ation de l'enregistrement.
          Aliment√© via CURRENT_TIMESTAMP().
        tests:
          - not_null

      - name: SOURCE_SYSTEM
        description: |
          Syst√®me source ayant aliment√© cette dimension.
          Valeur fixe : 'DVF' (Demandes de Valeurs Fonci√®res).

          Permet de tracer l'origine des donn√©es pour des enrichissements futurs.
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: 'DVF'

  # =============================================================================
  # MOD√àLE AGR√âG√â : KPIs NIVEAU FRANCE
  # =============================================================================
  - name: gold_kpi_france
    description: |
      **Mod√®le agr√©g√© - KPIs au niveau France par ann√©e**

      Table pr√©-agr√©g√©e contenant les indicateurs cl√©s de performance du march√© immobilier fran√ßais
      calcul√©s au niveau national pour chaque ann√©e.

      **üéØ Objectif :**
      Fournir des donn√©es optimis√©es pour la vue France de l'application Streamlit,
      garantissant un chargement rapide (< 5s) en √©vitant les agr√©gations √† la vol√©e sur fct_mutation.

      **üìä M√©triques disponibles :**
      - Prix m√©dian au m¬≤ global (tous types de biens confondus)
      - Prix m√©dian au m¬≤ par type de bien (Appartement, Maison)
      - Nombre total de ventes
      - Nombre de ventes par type de bien

      **Grain :** Une ligne par ann√©e

      **Source :** Agr√©gation de fct_mutation

    columns:
      - name: ANNEE
        description: |
          **Ann√©e de la transaction**

          Extraite de DATE_MUTATION via EXTRACT(YEAR FROM ...).
          Permet l'analyse de l'√©volution temporelle des indicateurs.
        tests:
          - not_null

      - name: PRIX_MEDIAN_M2
        description: |
          **Prix m√©dian au m¬≤ national** (tous types de biens confondus).

          Calcul√© via MEDIAN(VALEUR_FONCIERE / SURFACE_REELLE_BATI).

          Filtre appliqu√© : Exclut les transactions sans surface ou avec surface nulle.

          **Utilisation :** KPI principal pour la vue France, affichage en header.
        tests:
          - not_null
          - prix_median_positif

      - name: NB_VENTES
        description: |
          **Nombre total de ventes** au niveau France pour l'ann√©e.

          Comptage de toutes les transactions apr√®s filtrage (VALEUR_FONCIERE et SURFACE_REELLE_BATI non nuls).

          **Utilisation :** Volum√©trie nationale, affichage en KPI header.
        tests:
          - not_null

      - name: PRIX_MEDIAN_APPARTEMENT
        description: |
          **Prix m√©dian au m¬≤ pour les appartements uniquement**.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'APPARTEMENT' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente d'appartement pour l'ann√©e (rare).

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: NB_VENTES_APPARTEMENT
        description: |
          **Nombre de ventes d'appartements** au niveau France.

          Comptage conditionnel sur TYPE_LOCAL = 'APPARTEMENT'.

          **Utilisation :** Volum√©trie par type, comparaison march√© appartements vs maisons.
        tests:
          - not_null

      - name: PRIX_MEDIAN_MAISON
        description: |
          **Prix m√©dian au m¬≤ pour les maisons uniquement**.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'MAISON' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente de maison pour l'ann√©e (rare).

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: NB_VENTES_MAISON
        description: |
          **Nombre de ventes de maisons** au niveau France.

          Comptage conditionnel sur TYPE_LOCAL = 'MAISON'.

          **Utilisation :** Volum√©trie par type, comparaison march√© appartements vs maisons.
        tests:
          - not_null

  # =============================================================================
  # MOD√àLE AGR√âG√â : KPIs NIVEAU D√âPARTEMENT
  # =============================================================================
  - name: gold_kpi_departement
    description: |
      **Mod√®le agr√©g√© - KPIs par d√©partement et ann√©e**

      Table pr√©-agr√©g√©e contenant les indicateurs cl√©s de performance du march√© immobilier
      calcul√©s au niveau d√©partemental pour chaque ann√©e.

      **üéØ Objectif :**
      Fournir des donn√©es optimis√©es pour le drill-down d√©partement de l'application Streamlit,
      garantissant un chargement rapide (< 3s) avec coordonn√©es GPS pour la heatmap.

      **üìä M√©triques disponibles :**
      - Prix m√©dian au m¬≤ global par d√©partement
      - Prix m√©dian au m¬≤ par type de bien (Appartement, Maison)
      - Nombre de ventes par d√©partement
      - Nombre de ventes par type de bien
      - Centroids g√©ographiques (LATITUDE, LONGITUDE) pour positionnement carte

      **Grain :** Une ligne par couple (CODE_DEPARTEMENT, ANNEE)

      **Source :** Agr√©gation de fct_mutation

      **Enrichissement :** Jointure avec ref_departements pour obtenir NOM_DEPARTEMENT

    columns:
      - name: CODE_DEPARTEMENT
        description: |
          **Code d√©partement** (2 ou 3 caract√®res).

          Exemples : "75" (Paris), "13" (Bouches-du-Rh√¥ne), "2A" (Corse-du-Sud), "971" (Guadeloupe).

          Cl√© de jointure avec dim_commune et ref_departements.
        tests:
          - not_null

      - name: NOM_DEPARTEMENT
        description: |
          **Nom du d√©partement** (libell√© officiel).

          Issu du seed ref_departements.csv via jointure sur CODE_DEPARTEMENT.

          Fallback : Si d√©partement inconnu dans le seed, affiche CODE_DEPARTEMENT.

          Exemples : "Paris", "Bouches-du-Rh√¥ne", "Corse-du-Sud".

          **Utilisation :** Affichage lisible dans l'UI Streamlit (tooltips, labels).
        tests:
          - not_null

      - name: ANNEE
        description: |
          **Ann√©e de la transaction**

          Extraite de DATE_MUTATION via EXTRACT(YEAR FROM ...).
          Permet l'analyse de l'√©volution temporelle par d√©partement.
        tests:
          - not_null

      - name: PRIX_MEDIAN_M2
        description: |
          **Prix m√©dian au m¬≤ du d√©partement** (tous types de biens confondus).

          Calcul√© via MEDIAN(VALEUR_FONCIERE / SURFACE_REELLE_BATI) group√© par d√©partement.

          Filtre appliqu√© : Exclut les transactions sans surface ou avec surface nulle.

          **Utilisation :** Coloration de la heatmap d√©partement, affichage en tooltip.
        tests:
          - not_null
          - prix_median_positif

      - name: NB_VENTES
        description: |
          **Nombre total de ventes** dans le d√©partement pour l'ann√©e.

          Comptage de toutes les transactions apr√®s filtrage.

          **Utilisation :** Volum√©trie d√©partementale, validation seuil minimum (5 ventes).
        tests:
          - not_null

      - name: PRIX_MEDIAN_APPARTEMENT
        description: |
          **Prix m√©dian au m¬≤ pour les appartements** dans le d√©partement.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'APPARTEMENT' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente d'appartement dans le d√©partement pour l'ann√©e.

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: NB_VENTES_APPARTEMENT
        description: |
          **Nombre de ventes d'appartements** dans le d√©partement.

          Comptage conditionnel sur TYPE_LOCAL = 'APPARTEMENT'.
        tests:
          - not_null

      - name: PRIX_MEDIAN_MAISON
        description: |
          **Prix m√©dian au m¬≤ pour les maisons** dans le d√©partement.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'MAISON' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente de maison dans le d√©partement pour l'ann√©e.

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: NB_VENTES_MAISON
        description: |
          **Nombre de ventes de maisons** dans le d√©partement.

          Comptage conditionnel sur TYPE_LOCAL = 'MAISON'.
        tests:
          - not_null

      - name: LATITUDE_CENTROID
        description: |
          **Latitude du centroid g√©ographique du d√©partement**.

          Calcul√©e via AVG(LATITUDE) des transactions du d√©partement, avec fallback
          sur les coordonn√©es de r√©f√©rence du seed ref_departements si aucune transaction g√©ocod√©e.

          Coordonn√©e GPS en degr√©s d√©cimaux (WGS84).

          **Utilisation :** Positionnement des d√©partements sur la carte France (Pydeck heatmap).
        tests:
          - not_null

      - name: LONGITUDE_CENTROID
        description: |
          **Longitude du centroid g√©ographique du d√©partement**.

          Calcul√©e via AVG(LONGITUDE) des transactions du d√©partement, avec fallback
          sur les coordonn√©es de r√©f√©rence du seed ref_departements si aucune transaction g√©ocod√©e.

          Coordonn√©e GPS en degr√©s d√©cimaux (WGS84).

          **Utilisation :** Positionnement des d√©partements sur la carte France (Pydeck heatmap).
        tests:
          - not_null

  # =============================================================================
  # TABLE DE FAITS : MUTATIONS IMMOBILI√àRES
  # =============================================================================
  - name: fct_mutation
    description: |
      **Table de Faits - Mutations immobili√®res DVF avec g√©ocodage BAN**

      Table centrale du mod√®le en √©toile contenant toutes les transactions immobili√®res (ventes).

      **‚ú® NOUVEAU** : Enrichissement g√©ographique via Base Adresse Nationale (BAN)
      - Coordonn√©es GPS (longitude, latitude) pour cartographie
      - Code INSEE pour croisements statistiques
      - M√©tadonn√©es de qualit√© du g√©ocodage (GEOCODING_MATCH_LEVEL, GEOCODING_MATCH_SCORE)

      **Architecture :**
      - Sch√©ma en √©toile (star schema)
      - Cl√©s √©trang√®res vers 5 dimensions : address_enriched, commune, parcelle, type_local, code_postal
      - Mesures : valeur fonci√®re, surfaces, nombre de pi√®ces
      - Attributs d√©g√©n√©r√©s : date mutation, nature mutation
      - Enrichissement g√©ographique : coordonn√©es GPS BAN

      **Strat√©gie de jointure ADDRESS :**
      La colonne ADDRESS_MATCH_STRATEGY trace la qualit√© du lien adresse :
      - 'MATCH_ADDRESS' : jointure parfaite sur 6 champs (meilleure qualit√©)
      - 'FALLBACK_COMMUNE' : fallback sur commune uniquement (adresse incompl√®te)
      - 'NO_MATCH' : aucun match (cas marginal, n√©cessite investigation)

      Si aucune adresse exacte n'est trouv√©e, un ADDRESS_ID de secours est g√©n√©r√© via
      HASH('UNKNOWN|' || commune || d√©partement).

      **Processus de construction :**
      1. Nettoyage et normalisation des donn√©es silver
      2. Jointures LEFT avec les 5 dimensions
      3. Application strat√©gie de fallback pour ADDRESS_ID
      4. Calcul du flag ADDRESS_MATCH_STRATEGY

      **Utilisation :**
      - Analyses du march√© immobilier (prix au m¬≤, √©volution temporelle)
      - Reporting g√©ographique multi-niveaux (adresse, commune, d√©partement, CP)
      - √âtudes par typologie de biens
      - Analyses cadastrales et fonci√®res

      **Grain :** Une ligne par transaction immobili√®re (mutation)

    columns:
      # -------------------------------------------------------------------------
      # CL√âS √âTRANG√àRES (Foreign Keys)
      # -------------------------------------------------------------------------
      - name: ADDRESS_ID
        description: |
          **Cl√© √©trang√®re** vers dim_address_enriched.

          Lien vers l'adresse normalis√©e enrichie BAN du bien.

          **Strat√©gie de jointure avec fallback :**
          1. Tentative de match sur 6 champs normalis√©s (NO_VOIE, TYPE_DE_VOIE, VOIE, CP, COMMUNE, DEPT)
          2. Si √©chec : g√©n√©ration d'un ADDRESS_ID de secours via HASH('UNKNOWN|' || commune || d√©partement)
          3. Garantit l'absence de NULL (requis pour int√©grit√© r√©f√©rentielle Power BI)

          Voir ADDRESS_MATCH_STRATEGY pour tracer la qualit√© du lien.
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_address_enriched')
                field: ADDRESS_ID
              config:
                where: "ADDRESS_MATCH_STRATEGY = 'MATCH_ADDRESS'"

      - name: COMMUNE_ID
        description: |
          **Cl√© √©trang√®re** vers dim_commune.

          Lien vers la commune du bien.
          Jointure sur COMMUNE + CODE_DEPARTEMENT normalis√©s.

          Peut √™tre NULL si commune absente ou non reconnue (cas marginal).
        tests:
          - relationships:
              arguments:
                to: ref('dim_commune')
                field: COMMUNE_ID

      - name: PARCELLE_ID
        description: |
          **Cl√© √©trang√®re** vers dim_parcelle.

          Lien vers la parcelle cadastrale.
          Jointure sur PREFIXE_DE_SECTION + SECTION + NO_PLAN + NO_VOLUME.

          Peut √™tre NULL si identifiant cadastral incomplet ou absent.
        tests:
          - relationships:
              arguments:
                to: ref('dim_parcelle')
                field: PARCELLE_ID

      - name: TYPE_LOCAL_ID
        description: |
          **Cl√© √©trang√®re** vers dim_type_local.

          Lien vers le type de bien (Maison, Appartement, etc.).

          Peut √™tre NULL si type non renseign√© (rare, car fallback 'INCONNU' appliqu√© en dimension).
        tests:
          - relationships:
              arguments:
                to: ref('dim_type_local')
                field: TYPE_LOCAL_ID

      - name: CODE_POSTAL_ID
        description: |
          **Cl√© √©trang√®re** vers dim_code_postal.

          Lien vers le code postal.
          Jointure sur CODE_POSTAL + CODE_DEPARTEMENT.

          Peut √™tre NULL si code postal absent ou mal form√©.
        tests:
          - relationships:
              arguments:
                to: ref('dim_code_postal')
                field: CODE_POSTAL_ID

      # -------------------------------------------------------------------------
      # ENRICHISSEMENT G√âOGRAPHIQUE BAN
      # -------------------------------------------------------------------------
      - name: BAN_ID
        description: |
          **Identifiant BAN** - ID unique de l'adresse dans la Base Adresse Nationale.

          H√©rit√© de dim_address_enriched via la jointure.

          NULL si :
          - Aucun match BAN trouv√© (GEOCODING_MATCH_LEVEL = 'NO_MATCH')
          - Matching par centro√Øde (CODE_POSTAL ou COMMUNE niveau)

          **Utilisation :**
          - Filtrer les transactions avec g√©ocodage pr√©cis : WHERE BAN_ID IS NOT NULL
          - Lien vers r√©f√©rentiel BAN pour enrichissements futurs

      - name: CODE_INSEE
        description: |
          **Code INSEE de la commune** (5 chiffres).

          Issu du g√©ocodage BAN via dim_address_enriched.

          Plus fiable que le nom de commune pour analyses administratives et croisements INSEE.

          NULL si pas de match BAN.

      - name: LONGITUDE
        description: |
          **Longitude GPS** en degr√©s d√©cimaux (WGS84).

          Coordonn√©e g√©ographique h√©rit√©e de dim_address_enriched.

          NULL si pas de g√©ocodage disponible.

          **‚ú® NOUVEAU** : Permet d√©sormais de cartographier les transactions DVF !

          **Utilisation :**
          - Visualisation Power BI Maps, Tableau, QGIS
          - Analyses de proximit√© (distance √† un point d'int√©r√™t)
          - Clustering g√©ographique (hotspots de prix)
          - Export vers SIG externe

          **Pr√©cision :** Varie selon GEOCODING_MATCH_LEVEL (voir documentation)

      - name: LATITUDE
        description: |
          **Latitude GPS** en degr√©s d√©cimaux (WGS84).

          Coordonn√©e g√©ographique h√©rit√©e de dim_address_enriched.

          NULL si pas de g√©ocodage disponible.

          **‚ú® NOUVEAU** : Active les fonctionnalit√©s g√©ospatiales sur les mutations.

          **Utilisation :**
          - Cartographie web
          - Calculs de distance (formule haversine)
          - Analyses spatiales (rayon, buffer, etc.)

          **Pr√©cision :** Varie selon GEOCODING_MATCH_LEVEL

      # -------------------------------------------------------------------------
      # TRA√áABILIT√â QUALIT√â
      # -------------------------------------------------------------------------
      - name: GEOCODING_MATCH_LEVEL
        description: |
          **Niveau de qualit√© du g√©ocodage BAN** de l'adresse.

          H√©rit√© de dim_address_enriched.MATCH_LEVEL.

          Valeurs possibles (ordre d√©croissant de pr√©cision) :
          - **EXACT** : Match parfait, pr√©cision < 10m
          - **SANS_TYPE** : Match sans type de voie, pr√©cision ~10-20m
          - **VOIE_SEULE** : Centro√Øde de rue, pr√©cision ~50-200m
          - **CODE_POSTAL** : Centro√Øde code postal, pr√©cision ~200-500m
          - **COMMUNE** : Centro√Øde commune, pr√©cision > 500m
          - **NO_MATCH** : Pas de coordonn√©es GPS

          **üí° Recommandation :**
          Pour analyses g√©ospatiales fiables, filtrer sur :
          ```sql
          WHERE GEOCODING_MATCH_LEVEL IN ('EXACT', 'SANS_TYPE')
          ```

          **Utilisation :**
          - Filtrage qualit√© pour cartes et analyses spatiales
          - KPI de couverture g√©ographique
          - Segmentation par pr√©cision du g√©ocodage

      - name: GEOCODING_MATCH_SCORE
        description: |
          **Score de qualit√© du g√©ocodage** (0-100).

          H√©rit√© de dim_address_enriched.MATCH_SCORE.

          √âchelle :
          - 100 = EXACT (meilleure qualit√©)
          - 90 = SANS_TYPE
          - 70 = VOIE_SEULE
          - 50 = CODE_POSTAL
          - 30 = COMMUNE
          - 0 = NO_MATCH (pas de coordonn√©es)

          **Utilisation :**
          - Filtrage : WHERE GEOCODING_MATCH_SCORE >= 70
          - Pond√©ration dans les agr√©gations
          - M√©triques de qualit√© du data warehouse

      - name: ADDRESS_MATCH_STRATEGY
        description: |
          **Indicateur de qualit√© du lien adresse**

          Valeurs possibles :
          - 'MATCH_ADDRESS' : Jointure r√©ussie sur adresse compl√®te (6 champs)
            ‚Üí Meilleure qualit√©, g√©olocalisation pr√©cise possible

          - 'FALLBACK_COMMUNE' : Adresse incompl√®te, fallback sur commune uniquement
            ‚Üí Qualit√© moyenne, g√©olocalisation au niveau commune

          - 'NO_MATCH' : Aucun match (ni adresse ni commune)
            ‚Üí Qualit√© faible, n√©cessite investigation des donn√©es sources

          **Utilisation :**
          - Filtrer les analyses sur MATCH_ADDRESS pour garantir pr√©cision g√©ographique
          - Identifier les lignes n√©cessitant enrichissement ou correction
          - Mesurer la qualit√© globale du r√©f√©rentiel adresse
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['MATCH_ADDRESS', 'FALLBACK_COMMUNE', 'NO_MATCH']

      # -------------------------------------------------------------------------
      # ATTRIBUTS D√âG√âN√âR√âS
      # -------------------------------------------------------------------------
      - name: DATE_MUTATION
        description: |
          **Date de la mutation** (transaction immobili√®re).

          Format : DATE (YYYY-MM-DD)
          Source : convertie depuis format texte DD/MM/YYYY.

          **Utilisation :**
          - Analyses temporelles (√©volutions prix, volum√©trie)
          - Segmentation par p√©riode (mois, trimestre, ann√©e)
          - Calcul d'indicateurs glissants (moyenne mobile 12 mois, etc.)
        tests:
          - not_null

      - name: NATURE_MUTATION
        description: |
          Nature juridique de la mutation.

          Valeur unique dans cette table : 'Vente'
          (Le filtre est appliqu√© en amont dans dvf_silver et fact_mutation)

          Autres valeurs possibles dans les donn√©es brutes (non incluses ici) :
          - √âchange
          - Adjudication
          - Expropriation
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['Vente']

      # -------------------------------------------------------------------------
      # MESURES (Metrics)
      # -------------------------------------------------------------------------
      - name: VALEUR_FONCIERE
        description: |
          **Montant de la transaction** en euros (‚Ç¨).

          Valeur num√©rique convertie depuis format texte (virgule ‚Üí point).

          **Filtre appliqu√© en amont :** > 20 000 ‚Ç¨

          **Utilisation :**
          - Analyses de prix (m√©diane, moyenne, distribution)
          - Calcul prix au m¬≤ (VALEUR_FONCIERE / SURFACE_REELLE_BATI)
          - Segmentation par tranches de prix
          - D√©tection outliers (valeurs aberrantes)

          **Attention :** Peut inclure plusieurs biens dans une m√™me transaction.

      - name: SURFACE_REELLE_BATI
        description: |
          **Surface habitable du bien** en m¬≤.

          Surface r√©elle du b√¢ti (loi Carrez pour copropri√©t√©s).
          Valeur num√©rique convertie depuis format texte.

          **Utilisation :**
          - Calcul prix au m¬≤ habitable
          - Segmentation par taille de bien
          - Analyses de march√© par typologie

          Peut √™tre NULL pour :
          - Terrains nus (pas de b√¢ti)
          - Donn√©es incompl√®tes

      - name: NOMBRE_PIECES_PRINCIPALES
        description: |
          **Nombre de pi√®ces principales** du bien.

          D√©finition : chambres, salon, salle √† manger, bureau.
          Exclut : cuisine, salle de bains, WC, couloirs, d√©gagements.

          Valeur num√©rique convertie via TRY_TO_NUMBER (NULL si conversion √©choue).

          **Utilisation :**
          - Typologie T1, T2, T3, T4, T5+ (T = nombre de pi√®ces hors cuisine)
          - Analyses par segment (studio, 2 pi√®ces, 3 pi√®ces, etc.)
          - Calcul prix par pi√®ce

          Peut √™tre NULL pour :
          - Locaux commerciaux ou industriels
          - Terrains nus
          - Donn√©es manquantes

      - name: SURFACE_TERRAIN
        description: |
          **Surface du terrain** en m¬≤.

          Surface cadastrale de la parcelle.
          Valeur num√©rique convertie depuis format texte.

          **Utilisation :**
          - Analyses fonci√®res
          - Calcul prix au m¬≤ de terrain
          - Segmentation maisons avec/sans terrain
          - √âtudes densit√© urbaine

          Peut √™tre NULL pour :
          - Appartements (pas de terrain privatif)
          - Donn√©es incompl√®tes

          **Note :** Pour une maison, SURFACE_TERRAIN > SURFACE_REELLE_BATI (terrain inclut jardin, parking, etc.)

      # -------------------------------------------------------------------------
      # M√âTADONN√âES TECHNIQUES
      # -------------------------------------------------------------------------
      - name: CREATED_AT
        description: |
          Horodatage de cr√©ation de l'enregistrement dans la fact table.
          Aliment√© via CURRENT_TIMESTAMP() lors de l'ex√©cution dbt.

          **Utilisation :**
          - Audit et tra√ßabilit√© des chargements
          - D√©tection des nouvelles lignes depuis dernier run
          - Debugging pipelines dbt
        tests:
          - not_null

  # =============================================================================
  # MOD√àLE AGR√âG√â : KPIs NIVEAU COMMUNE
  # =============================================================================
  - name: gold_kpi_commune
    description: |
      **Mod√®le agr√©g√© - KPIs par commune et ann√©e**

      Table pr√©-agr√©g√©e contenant les indicateurs cl√©s de performance du march√© immobilier
      calcul√©s au niveau communal pour chaque ann√©e.

      **üéØ Objectif :**
      Fournir des donn√©es optimis√©es pour le drill-down commune de l'application Streamlit,
      garantissant un chargement rapide (< 3s) avec coordonn√©es GPS pour la heatmap.

      **üìä M√©triques disponibles :**
      - Prix m√©dian au m¬≤ global par commune
      - Prix m√©dian au m¬≤ par type de bien (Appartement, Maison)
      - Nombre de ventes par commune
      - Centroids g√©ographiques (LATITUDE, LONGITUDE) pour positionnement carte
      - Indicateur de donn√©es suffisantes (HAS_SUFFICIENT_DATA)

      **Grain :** Une ligne par couple (CODE_COMMUNE, ANNEE)

      **Source :** Agr√©gation de fct_mutation avec enrichissement BAN

    columns:
      - name: CODE_COMMUNE
        description: |
          **Code INSEE de la commune** (5 caract√®res).

          Identifiant officiel INSEE de la commune.
          Exemples : "75056" (Paris), "13055" (Marseille), "69123" (Lyon).

          Cl√© de jointure avec gold_kpi_code_postal pour le drill-down.
        tests:
          - not_null

      - name: NOM_COMMUNE
        description: |
          **Nom de la commune** (libell√© normalis√©).

          Issu de dim_commune, normalis√© en majuscules.

          Exemples : "PARIS", "MARSEILLE", "LYON".

          **Utilisation :** Affichage lisible dans l'UI Streamlit (tooltips, labels).

      - name: CODE_DEPARTEMENT
        description: |
          **Code d√©partement** (2 ou 3 caract√®res).

          Permet le filtrage par d√©partement pour le drill-down depuis gold_kpi_departement.

          Exemples : "75" (Paris), "13" (Bouches-du-Rh√¥ne), "971" (Guadeloupe).
        tests:
          - not_null

      - name: ANNEE
        description: |
          **Ann√©e de la transaction**

          Extraite de DATE_MUTATION via EXTRACT(YEAR FROM ...).
          Permet l'analyse de l'√©volution temporelle par commune.
        tests:
          - not_null

      - name: PRIX_MEDIAN_M2
        description: |
          **Prix m√©dian au m¬≤ de la commune** (tous types de biens confondus).

          Calcul√© via MEDIAN(VALEUR_FONCIERE / SURFACE_REELLE_BATI) group√© par commune.

          Filtre appliqu√© : Exclut les transactions sans surface ou avec surface nulle.

          **Utilisation :** Coloration de la heatmap commune, affichage en tooltip.
        tests:
          - not_null
          - prix_median_positif

      - name: NB_VENTES
        description: |
          **Nombre total de ventes** dans la commune pour l'ann√©e.

          Comptage de toutes les transactions apr√®s filtrage.

          **Utilisation :** Volum√©trie communale, validation seuil minimum (5 ventes).
        tests:
          - not_null

      - name: PRIX_MEDIAN_APPARTEMENT
        description: |
          **Prix m√©dian au m¬≤ pour les appartements** dans la commune.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'APPARTEMENT' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente d'appartement dans la commune pour l'ann√©e.

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: PRIX_MEDIAN_MAISON
        description: |
          **Prix m√©dian au m¬≤ pour les maisons** dans la commune.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'MAISON' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente de maison dans la commune pour l'ann√©e.

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: LATITUDE_CENTROID
        description: |
          **Latitude du centroid g√©ographique de la commune**.

          Calcul√©e via AVG(LATITUDE) des transactions de la commune.
          COALESCE √† 0 si aucune coordonn√©e disponible.

          Coordonn√©e GPS en degr√©s d√©cimaux (WGS84).

          **Utilisation :** Positionnement des communes sur la carte (Pydeck heatmap).
        tests:
          - not_null

      - name: LONGITUDE_CENTROID
        description: |
          **Longitude du centroid g√©ographique de la commune**.

          Calcul√©e via AVG(LONGITUDE) des transactions de la commune.
          COALESCE √† 0 si aucune coordonn√©e disponible.

          Coordonn√©e GPS en degr√©s d√©cimaux (WGS84).

          **Utilisation :** Positionnement des communes sur la carte (Pydeck heatmap).
        tests:
          - not_null

      - name: HAS_SUFFICIENT_DATA
        description: |
          **Indicateur de donn√©es suffisantes** pour l'analyse.

          TRUE si NB_VENTES >= 5, FALSE sinon.

          Seuil de 5 transactions d√©fini dans les sp√©cifications UX (FR15).

          **Utilisation Streamlit :**
          - Colorer les zones insuffisantes en gris
          - Bloquer le drill-down
          - Afficher st.warning("Donn√©es insuffisantes")
        tests:
          - not_null

  # =============================================================================
  # MOD√àLE AGR√âG√â : KPIs NIVEAU CODE POSTAL
  # =============================================================================
  - name: gold_kpi_code_postal
    description: |
      **Mod√®le agr√©g√© - KPIs par code postal et ann√©e**

      Table pr√©-agr√©g√©e contenant les indicateurs cl√©s de performance du march√© immobilier
      calcul√©s au niveau code postal pour chaque ann√©e.

      **üéØ Objectif :**
      Fournir des donn√©es optimis√©es pour le drill-down code postal de l'application Streamlit,
      garantissant un chargement rapide (< 3s) avec coordonn√©es GPS pour la heatmap.

      **üìä M√©triques disponibles :**
      - Prix m√©dian au m¬≤ global par code postal
      - Prix m√©dian au m¬≤ par type de bien (Appartement, Maison)
      - Nombre de ventes par code postal
      - Centroids g√©ographiques (LATITUDE, LONGITUDE) pour positionnement carte
      - Indicateur de donn√©es suffisantes (HAS_SUFFICIENT_DATA)

      **Grain :** Une ligne par triplet (CODE_POSTAL, CODE_COMMUNE, ANNEE) - permet le filtrage fin par commune

      **Source :** Agr√©gation de fct_mutation avec enrichissement BAN

    columns:
      - name: CODE_POSTAL
        description: |
          **Code postal** (5 caract√®res).

          Code postal fran√ßais.
          Exemples : "75001" (Paris 1er), "13001" (Marseille 1er), "69001" (Lyon 1er).

          Cl√© principale pour ce niveau d'agr√©gation.
        tests:
          - not_null

      - name: CODE_COMMUNE
        description: |
          **Code INSEE de la commune** (5 caract√®res).

          Fait partie de la cl√© de grain avec CODE_POSTAL et ANNEE.
          Permet le filtrage fin par commune pour le drill-down depuis gold_kpi_commune.

          Note : Un code postal peut couvrir plusieurs communes, donc il peut y avoir
          plusieurs lignes par CODE_POSTAL+ANNEE (une par commune associ√©e).

          Peut √™tre NULL si l'adresse n'a pas pu √™tre enrichie avec le CODE_INSEE BAN.

      - name: ANNEE
        description: |
          **Ann√©e de la transaction**

          Extraite de DATE_MUTATION via EXTRACT(YEAR FROM ...).
          Permet l'analyse de l'√©volution temporelle par code postal.
        tests:
          - not_null

      - name: PRIX_MEDIAN_M2
        description: |
          **Prix m√©dian au m¬≤ du code postal** (tous types de biens confondus).

          Calcul√© via MEDIAN(VALEUR_FONCIERE / SURFACE_REELLE_BATI) group√© par code postal.

          Filtre appliqu√© : Exclut les transactions sans surface ou avec surface nulle.

          **Utilisation :** Coloration de la heatmap code postal, affichage en tooltip.
        tests:
          - not_null
          - prix_median_positif

      - name: NB_VENTES
        description: |
          **Nombre total de ventes** dans le code postal pour l'ann√©e.

          Comptage de toutes les transactions apr√®s filtrage.

          **Utilisation :** Volum√©trie par code postal, validation seuil minimum (5 ventes).
        tests:
          - not_null

      - name: PRIX_MEDIAN_APPARTEMENT
        description: |
          **Prix m√©dian au m¬≤ pour les appartements** dans le code postal.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'APPARTEMENT' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente d'appartement dans le code postal pour l'ann√©e.

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: PRIX_MEDIAN_MAISON
        description: |
          **Prix m√©dian au m¬≤ pour les maisons** dans le code postal.

          Calcul√© via MEDIAN(CASE WHEN TYPE_LOCAL = 'MAISON' THEN VALEUR_FONCIERE / SURFACE_REELLE_BATI END).

          NULL si aucune vente de maison dans le code postal pour l'ann√©e.

          **Utilisation :** Segmentation par type de bien, filtre Streamlit.
        tests:
          - prix_median_positif

      - name: LATITUDE_CENTROID
        description: |
          **Latitude du centroid g√©ographique du code postal**.

          Calcul√©e via AVG(LATITUDE) des transactions du code postal.
          COALESCE √† 0 si aucune coordonn√©e disponible.

          Coordonn√©e GPS en degr√©s d√©cimaux (WGS84).

          **Utilisation :** Positionnement des codes postaux sur la carte (Pydeck heatmap).
        tests:
          - not_null

      - name: LONGITUDE_CENTROID
        description: |
          **Longitude du centroid g√©ographique du code postal**.

          Calcul√©e via AVG(LONGITUDE) des transactions du code postal.
          COALESCE √† 0 si aucune coordonn√©e disponible.

          Coordonn√©e GPS en degr√©s d√©cimaux (WGS84).

          **Utilisation :** Positionnement des codes postaux sur la carte (Pydeck heatmap).
        tests:
          - not_null

      - name: HAS_SUFFICIENT_DATA
        description: |
          **Indicateur de donn√©es suffisantes** pour l'analyse.

          TRUE si NB_VENTES >= 5, FALSE sinon.

          Seuil de 5 transactions d√©fini dans les sp√©cifications UX (FR15).

          **Utilisation Streamlit :**
          - Colorer les zones insuffisantes en gris
          - Bloquer le drill-down
          - Afficher st.warning("Donn√©es insuffisantes")
        tests:
          - not_null
